INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-1, '1990-01-01 00:00:00', 'Secanj', 'Srbija', 'admin@example.com', '123456789', 'Migo', '$2a$10$h9fD5LSSJ/cxG6pysikeOes5ANhA05FDyYi1tiw0mlSEYk8AKQC12', '066200555', 'LEAGUE_ADMIN', 'Radovanovic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-2, '2001-03-23 00:00:00', 'Subotica', 'Serbia', 'lukazecevic5@gmail.com', '2303001820001', 'Luka', '$2a$10$ZxYbZmsjKeV16wh0tm5Skeyg96/XhxelPqQrqem4I.1eiAyfOkpry', '0645547252', 'RECORD_KEEPER', 'Zecevic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-3, '1990-01-01 00:00:00', 'Subaja', 'Srbija', 'zapisnicar@example.com', '123456789', 'Zapisnicar', '$2a$10$ZxYbZmsjKeV16wh0tm5Skeyg96/XhxelPqQrqem4I.1eiAyfOkpry', '066200555', 'RECORD_KEEPER', 'Zapisnic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-4, '2024-04-02 00:00:00', 'Belgrade', 'Serbia', 'kp@gmail.com', '2303001820001', 'Kevin', '$2a$10$4iIeUrlfMNHkDZoktBitveJuH.rAyVYH/bBsncWjyfom2Nx07CvGm', '06426417', 'PLAYER', 'Punter');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-5, '2024-04-03 00:00:00', 'Belgrade', 'Serbia', 'leday@gmail.com', '2303001820001', 'Zach', '$2a$10$2IfOpr6/.1t1jbtX9/vDh.VXTBfCHSWMW0xjHEHOQLgfCToZfsBLy', '0645547252', 'PLAYER', 'Leday');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-6, '2024-04-02 00:00:00', 'Belgrade', 'Serbia', 'nunnaly@gmail.com', '2303001820001', 'James', '$2a$10$3OHO/UBHWXnAtRDDCKtACubU0zMD4UiSJrGEpDpRx9QUzzyQbMpB.', '0645547252', 'PLAYER', 'Nunnaly');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-7, '2024-05-01 00:00:00', 'Belgrade', 'Serbia', 'mathi@gmail.com', '2303001820001', 'Mathias',	'$2a$10$wzJIoW4OogxEPT6bcTo0w.xhZxvsv5S64PHO1HiDaZWk6pL7zTZdS',	'0645547252',	'PLAYER',	'Lessort');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-8, '2024-05-01 00:00:00', 'Belgrade', 'Serbia', 'dante@gmail.com', '2303001820001', 'Dante',	'$2a$10$W1pWaOQo0gbRLqszxgBYBuLW6U.t4cd63AzdkS5f4Chajc5Nbb6Gu',	'0645547252',	'PLAYER',	'Exum');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-9, '2024-05-02 00:00:00', 'Belgrade', 'Serbia', 'aleksa@gmail.com', '2303001820001', 'Aleksa',	'$2a$10$Aju.R3jCpCkOUEWveIsGsuneq.JJQU/2DEj6OSb5M6e9rgUalD8N6',	'0645547252',	'PLAYER',	'Avramovic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-10, '2024-04-02 00:00:00', 'Belgrade', 'Serbia', 'joel@gmail.com', '2303001820001', 'Joel', '$2a$10$4iIeUrlfMNHkDZoktBitveJuH.rAyVYH/bBsncWjyfom2Nx07CvGm', '06426417', 'PLAYER', 'Bolomboy');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-11, '2024-04-02 00:00:00', 'Belgrade', 'Serbia', 'nemanja@gmail.com', '2303001820001', 'Nemanja', '$2a$10$4iIeUrlfMNHkDZoktBitveJuH.rAyVYH/bBsncWjyfom2Nx07CvGm', '06426417', 'PLAYER', 'Nedovic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-12, '2024-05-02 00:00:00', 'Belgrade', 'Serbia', 'teo@gmail.com', '2303001820001', 'Milos',	'$2a$10$Aju.R3jCpCkOUEWveIsGsuneq.JJQU/2DEj6OSb5M6e9rgUalD8N6',	'0645547252',	'PLAYER',	'Teodosic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-13, '2024-05-01 00:00:00', 'Subotica', 'Serbia', 'kalina@gmail.com', '2303001820001', 'Nikola',	'$2a$10$6BAerO0s2/mmn9WivVXICeKYyuWOxFuWOuekyBLA9J3EfVoS0JYUC',	'0645548252',	'PLAYER',	'Kalinic');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-14, '2024-04-02 00:00:00', 'Belgrade', 'Serbia', 'adam@gmail.com', '2303001820001', 'Adam', '$2a$10$4iIeUrlfMNHkDZoktBitveJuH.rAyVYH/bBsncWjyfom2Nx07CvGm', '06426417', 'PLAYER', 'Hanga');
INSERT INTO public.users (id, birthday, city, country, email, jmbg, name, password, phone_number, role, surname) VALUES (-15, '2024-05-02 00:00:00', 'Belgrade', 'Serbia', 'giedraitis@gmail.com', '2303001820001', 'Rokas',	'$2a$10$Aju.R3jCpCkOUEWveIsGsuneq.JJQU/2DEj6OSb5M6e9rgUalD8N6',	'0645547252',	'PLAYER',	'Giedraitis');
INSERT INTO public.record_keepers (id) VALUES (-2);
INSERT INTO public.record_keepers (id) VALUES (-3);
INSERT INTO public.teams (id, address, city, country, email, name, phone_number) VALUES (-2, 'adresa', 'Belgrade', 'Serbia', 'czv@gmail.com', 'Crvena Zvezda', '0645547252');
INSERT INTO public.teams (id, address, city, country, email, name, phone_number) VALUES (-1, 'adresa', 'Belgrade', 'Serbia', 'partizan@gmail.com', 'Partizan', '0645547252');
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 7, 0, 77, -4, -1);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (197, 9, 0, 98, -5, -1);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (192, 5, 0, 82, -6, -1);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 75, 0, 77, -7, -1);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 57, 0, 77, -8, -1);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 11, 0, 77, -9, -1);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (192, 24, 0, 82, -10, -2);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 13, 0, 77, -11, -2);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 11, 0, 77, -12, -2);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 4, 0, 77, -13, -2);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 20, 0, 77, -14, -2);
INSERT INTO public.players (height, jersey_number, status, weight, id, team_id) VALUES (190, 1, 0, 77, -15, -2);
INSERT INTO public.matches (id, away_team_id, city, fourthrefereeid, home_team_id, mainrefereeid, matchday, secondrefereeid, thirdrefereeid, record_keeper_id, away_roster_id, home_roster_id) VALUES (-1, -2, 'Belgrade', 4, -1, 1, '2024-05-13 12:00:00', 2, 3, -2, null, null);

CREATE OR REPLACE FUNCTION trg_match_event_ins_fn()
RETURNS TRIGGER AS $$
BEGIN
	BEGIN
        CASE NEW.event_type
            WHEN 'TWO_POINTER' THEN
                UPDATE public.player_match_stats
                SET two_pm = two_pm + 1,
                    two_pa = two_pa + 1,
                    points = points + 2,
                    two_pp = CAST(two_pm + 1 AS double precision) / (two_pa + 1),
                    player_index_rating = player_index_rating + 2
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;

                IF (SELECT team_id FROM players WHERE id = NEW.perpetrator_id) = (SELECT home_team_id FROM matches WHERE id = NEW.match_id) THEN
                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus + 2
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT home_roster_id FROM matches WHERE id = NEW.match_id));

                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus - 2
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT away_roster_id FROM matches WHERE id = NEW.match_id));
                ELSE
                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus + 2
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT away_roster_id FROM matches WHERE id = NEW.match_id));

                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus - 2
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT home_roster_id FROM matches WHERE id = NEW.match_id));
                END IF;


			WHEN 'THREE_POINTER' THEN
                UPDATE public.player_match_stats
                SET three_pm = three_pm + 1,
                    three_pa = three_pa + 1,
                    points = points + 3,
                    three_pp = CAST(three_pm + 1 AS double precision) / (three_pa + 1),
                    player_index_rating = player_index_rating + 3
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;

                IF (SELECT team_id FROM players WHERE id = NEW.perpetrator_id) = (SELECT home_team_id FROM matches WHERE id = NEW.match_id) THEN
                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus + 3
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT home_roster_id FROM matches WHERE id = NEW.match_id));

                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus - 3
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT away_roster_id FROM matches WHERE id = NEW.match_id));
                ELSE
                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus + 3
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT away_roster_id FROM matches WHERE id = NEW.match_id));

                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus - 3
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT home_roster_id FROM matches WHERE id = NEW.match_id));
                END IF;


			WHEN 'FREE_THROW_IN' THEN
                UPDATE public.player_match_stats
                SET free_throw_m = free_throw_m + 1,
                    free_throw_a = free_throw_a + 1,
                    points = points + 1,
                    free_throw_p = CAST(free_throw_m + 1 AS double precision) / (free_throw_a + 1),
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;

                IF (SELECT team_id FROM players WHERE id = NEW.perpetrator_id) = (SELECT home_team_id FROM matches WHERE id = NEW.match_id) THEN
                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus + 1
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT home_roster_id FROM matches WHERE id = NEW.match_id));

                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus - 1
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT away_roster_id FROM matches WHERE id = NEW.match_id));
                ELSE
                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus + 1
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT away_roster_id FROM matches WHERE id = NEW.match_id));

                    UPDATE public.player_match_stats
                    SET plus_minus = plus_minus - 1
                    WHERE match_id = NEW.match_id
                    AND player_id IN(SELECT player_id FROM match_roster_active_five WHERE match_roster_id = (SELECT home_roster_id FROM matches WHERE id = NEW.match_id));
                END IF;

			WHEN 'MISSED_TWO_POINTER' THEN
                UPDATE public.player_match_stats
                SET two_pa = two_pa + 1,
                    two_pp = CAST(two_pm AS double precision) / (two_pa + 1),
                    player_index_rating = player_index_rating - 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'MISSED_THREE_POINTER' THEN
                UPDATE public.player_match_stats
                SET three_pa = three_pa + 1,
                    three_pp = CAST(three_pm AS double precision) / (three_pa + 1),
                    player_index_rating = player_index_rating - 1
                    WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'MISSED_FREE_THROW' THEN
                UPDATE public.player_match_stats
                SET free_throw_a = free_throw_a + 1,
                    free_throw_p = CAST(free_throw_m AS double precision) / (free_throw_a + 1),
                    player_index_rating = player_index_rating - 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'DEF_REBOUND' THEN
                UPDATE public.player_match_stats
                SET defensive_rebounds = defensive_rebounds + 1,
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'OFF_REBOUND' THEN
                UPDATE public.player_match_stats
                SET offensive_rebounds = offensive_rebounds + 1,
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'ASSIST' THEN
                UPDATE public.player_match_stats
                SET assists = assists + 1,
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'TURNOVER' THEN
                UPDATE public.player_match_stats
                SET turnovers = turnovers + 1,
                    player_index_rating = player_index_rating - 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'STEAL' THEN
                UPDATE public.player_match_stats
                SET steals = steals + 1,
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'BLOCK' THEN
                UPDATE public.player_match_stats
                SET blocks = blocks + 1,
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'SHOT_REJECTED' THEN
                UPDATE public.player_match_stats
                SET blocks_against = blocks_against + 1,
                    player_index_rating = player_index_rating - 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'FOUL' THEN
                UPDATE public.player_match_stats
                SET fouls_commited = fouls_commited + 1,
                    player_index_rating = player_index_rating - 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'FOUL_DRAWN' THEN
                UPDATE public.player_match_stats
                SET fouls_drawn = fouls_drawn + 1,
                    player_index_rating = player_index_rating + 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			WHEN 'UNSPORTSMANLIKE_FOUL' THEN
                UPDATE public.player_match_stats
                SET fouls_commited = fouls_commited + 1,
                    player_index_rating = player_index_rating - 1
                WHERE match_id = NEW.match_id AND player_id = NEW.perpetrator_id;
			ELSE
                NULL;
				
        END CASE;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE EXCEPTION 'Player match stat not found for match_id: %, player_id: %', NEW.match_id, NEW.perpetrator_id;
            ROLLBACK;
    END;

    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE TRIGGER trg_match_event_ins
AFTER INSERT ON public.match_events
FOR EACH ROW
EXECUTE FUNCTION trg_match_event_ins_fn();